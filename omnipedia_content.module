<?php

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 *
 * This provides the help block contents for the 'entity.node.omnipedia_changes'
 * route.
 */
function omnipedia_content_help($routeName, RouteMatchInterface $routeMatch) {

  if ($routeName === 'entity.node.omnipedia_changes') {
    /** @var string */
    $baseClass = 'omnipedia-changes-help';

    return ['omnipedia_changes_help'  => [
      '#type'       => 'container',
      '#attributes' => ['class' => [$baseClass]],

      'description' => [
        '#type'   => 'html_tag',
        '#tag'    => 'p',
        '#value'  => \t('This displays additions, removals, and changes to the current page compared to the previous version, using the following indicators:'),
        '#attributes'   => ['class' => [$baseClass . '__description']],
      ],

      'legend'  => [
        '#theme'        => 'item_list',
        '#list_type'    => 'ul',
        '#items'        => [
          'added' => [
            '#type'   => 'html_tag',
            '#tag'    => 'ins',
            '#value'  => \t('Added'),
            '#wrapper_attributes'   => ['class' => [
              $baseClass . '__legend-item',
              $baseClass . '__legend-item--added',
            ]],
            '#attributes'   => ['class' => [
              $baseClass . '__diff',
              $baseClass . '__diff--added',
            ]],
          ],
          'removed' => [
            '#type'   => 'html_tag',
            '#tag'    => 'del',
            '#value'  => \t('Removed'),
            '#wrapper_attributes'   => ['class' => [
              $baseClass . '__legend-item',
              $baseClass . '__legend-item--removed',
            ]],
            '#attributes'   => ['class' => [
              $baseClass . '__diff',
              $baseClass . '__diff--removed',
            ]],
          ],
          'changed' => [
            '#type'   => 'html_tag',
            '#tag'    => 'span',
            '#value'  => \t('Changed'),
            '#wrapper_attributes'   => ['class' => [
              $baseClass . '__legend-item',
              $baseClass . '__legend-item--changed',
            ]],
            '#attributes'   => ['class' => [
              $baseClass . '__diff',
              $baseClass . '__diff--changed',
            ]],
          ],
        ],
        '#attributes'   => ['class' => [
          $baseClass . '__legend',
          'unlisted-list',
        ]],
      ],

      '#attached'   => [
        'library'     => ['omnipedia_content/component.changes'],
      ],
   ]];
  }

}

/**
 * Implements hook_markdown_extension_info_alter().
 *
 * This performs the following:
 *
 * - Replaces the heading permalink Markdown plug-in and CommonMark extension
 *   with our own plug-in and extension.
 *
 * - Replaces the 'rezozero/commonmark-ext-footnotes' extension with the
 *   'league/commonmark-ext-footnotes' extension that ships with CommonMark
 *   1.5+. Note that the extension name is not updated, and so will not apply
 *   our custom class when the Markdown module switches to the
 *   'league/commonmark-ext-footnotes' extension.
 *
 * @see \Drupal\omnipedia_content\Plugin\Markdown\CommonMark\Extension\HeadingPermalinkExtension
 *   Our heading permalink Markdown plug-in class.
 *
 * @see \Drupal\omnipedia_content\CommonMark\Extension\HeadingPermalink\HeadingPermalinkExtension
 *   Our heading permalink CommonMark extension.
 *
 * @see \Drupal\omnipedia_content\Plugin\Markdown\CommonMark\Extension\FootnoteExtension
 *   Our footnotes Markdown plug-in class.
 *
 * @see \League\CommonMark\Extension\Footnote\FootnoteExtension
 *   CommonMark 1.5+ footnotes extension.
 */
function omnipedia_content_markdown_extension_info_alter(array &$info) {
  $info['league/commonmark-ext-heading-permalink']['class'] =
    'Drupal\\omnipedia_content\\Plugin\\Markdown\\CommonMark\\Extension\\HeadingPermalinkExtension';

  // @todo Is this needed?
  $info['league/commonmark-ext-heading-permalink']['installedClass'] =
    'Drupal\\omnipedia_content\\CommonMark\\Extension\\HeadingPermalink\\HeadingPermalinkExtension';

  // Alter footnotes to use the version that now ships with CommonMark until the
  // Markdown module releases with support for it.
  if (isset($info['rezozero/commonmark-ext-footnotes'])) {
    $info['rezozero/commonmark-ext-footnotes']['class'] =
      'Drupal\\omnipedia_content\\Plugin\\Markdown\\CommonMark\\Extension\\FootnoteExtension';

    $info['rezozero/commonmark-ext-footnotes']['installedClass'] =
      'League\\CommonMark\\Extension\\Footnote\\FootnoteExtension';

    $info['rezozero/commonmark-ext-footnotes']['url'] =
      'https://commonmark.thephpleague.com/extensions/footnotes/';

    // Use CommonMark's installed status.
    $info['rezozero/commonmark-ext-footnotes']['installed'] =
      $info['league/commonmark-ext-heading-permalink']['installed'];
  }
}
